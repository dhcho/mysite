<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="board">
	<insert id="insert" parameterType="boardvo">
	  	
		INSERT
			INTO board
			(
				no,
				title, 
				contents, 
				reg_date, 
				hit, 
				group_no,
				order_no, 
				depth, 
				user_no)
		VALUES (
			(SELECT MAX(no)+1 FROM board A)
			#{title }, 
			#{contents }, 
			now(), 
			0, 
			(SELECT MAX(no)+1 FROM board A)
			0, 
			0, 
			#{userNo })
	</insert>
	
	<insert id="insertReply" parameterType="boardvo">
		INSERT
			INTO board(title, 
				contents, 
				reg_date, 
				hit, 
				group_no, 
				order_no, 
				depth, 
				user_no)
			VALUES (#{title }, 
				#{contents }, 
				now(), 
				0, 
				#{groupNo }, 
				(SELECT order_no+1 FROM board A WHERE no = #{groupNo}), 
				(SELECT depth+1 FROM board A WHERE no = #{groupNo}), 
				#{userNo })
	</insert>

	<select id="findAll" resultType="boardvo">
		<![CDATA[	
		  select a.no, a.title, a.depth, a.hit, b.no as userNo, b.name, a.reg_date
					     from board a, user b
						 where a.user_no = b.no
					 order by a.no desc
	  	]]>	
	</select>
	
	<select id="findCnt" resultType="int">
		  select count(*) 
		  	from board
		  <if test="kwd != null and kwd != '' ">
			where title like CONCAT('%',#{kwd},'%')
		  </if>
	</select>
	
	<select id="findPage" resultType="boardvo">
		  select a.no,
		  		 a.title,
		   		 a.hit, 
		   		 b.no as userNo, 
		   		 b.name as userName, 
		   		 DATE_FORMAT(a.reg_date,'%Y년%m월%d일 %H시%i분%S초') as regDate,
		   		 a.group_no,
		   		 a.order_no,
		   		 a.depth
			from board a, user b
				where a.user_no = b.no
			<if test="kwd != null and kwd != '' ">
				and a.title like CONCAT('%',#{kwd},'%')
			</if>
			order by a.group_no DESC, a.order_no ASC
			limit #{startPage }, #{onePageCnt }
	</select>
	
	<select id="findByNo" parameterType="int" resultType="boardvo">
		select no, 
			title, 
			contents, 
			depth, 
			hit, 
			group_no as groupNo,
			order_no as orderNo,
			depth,
			reg_date as regDate
		from board
		where no = #{no }
	</select>
	
	<update id="update" parameterType="boardvo">
				update board
				   set title = #{title }, contents = #{contents }
				 where no = #{no }
	</update>
	
	<update id="updateHit" parameterType="int">
				<![CDATA[
				update board
				   set hit = hit + 1
				 where no = #{no }
				]]>
	</update>
	
	<delete id="delete" parameterType="boardvo">
		<![CDATA[
		delete
		  from board
		  where no = #{no } and user_no = #{userNo }
	  	]]>	
	</delete>
</mapper>